<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeresspiegelanstieg Simulator - Interaktiver Geographie-Unterricht</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 50%, #1e3a5f 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .header h1 {
            font-size: 2.2em;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.1em;
            color: #34495e;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        .main-interface {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            margin-bottom: 25px;
            height: 600px;
        }

        .control-sidebar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            overflow-y: auto;
            padding: 20px;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .region-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .region-btn {
            padding: 10px 8px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .region-btn:hover, .region-btn.active {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            color: white;
            border-color: #2980b9;
            transform: translateY(-1px);
        }

        .slider-container {
            margin-bottom: 15px;
        }

        .slider-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #27ae60, #f39c12, #e74c3c);
            outline: none;
            margin-bottom: 10px;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #2c3e50;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #2c3e50;
            cursor: pointer;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .value-display {
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .cities-status {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }

        .city-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.85em;
            padding: 4px 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-safe { background: #27ae60; }
        .status-risk { background: #f1c40f; }
        .status-flooded { background: #3498db; }

        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-legend {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85em;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
        }

        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card p, .info-card ul {
            line-height: 1.6;
            color: #555;
            font-size: 0.95em;
        }

        .info-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .quiz-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .quiz-progress {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .quiz-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            transition: width 0.5s ease;
        }

        .question-container {
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .quiz-options {
            display: grid;
            gap: 10px;
        }

        .quiz-option {
            padding: 12px 15px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
        }

        .quiz-option:hover {
            background: #e9ecef;
            border-color: #4a90e2;
        }

        .quiz-option.correct {
            background: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .quiz-option.incorrect {
            background: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .quiz-feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .quiz-score {
            text-align: center;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 2000;
            max-width: 200px;
            line-height: 1.4;
        }

        @media (max-width: 1024px) {
            .main-interface {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .control-sidebar {
                order: 2;
            }
            
            .map-container {
                height: 400px;
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
                flex-direction: column;
                gap: 10px;
            }
            
            .region-selector {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span>🌊</span>Meeresspiegelanstieg Simulator<span>🏙️</span></h1>
            <p>Entdecke die globalen Auswirkungen des Klimawandels! Erlebe interaktiv, wie sich verschiedene Szenarien des Meeresspiegelanstiegs auf Küstenstädte und ganze Länder auswirken würden.</p>
        </div>

        <div class="main-interface">
            <div class="control-sidebar">
                <div class="control-section">
                    <h3>🗺️ Regionen erkunden</h3>
                    <div class="region-selector">
                        <button class="region-btn active">🌍 Weltkarte</button>
                        <button class="region-btn">🇪🇺 Europa</button>
                        <button class="region-btn">🇺🇸 Nordamerika</button>
                        <button class="region-btn">🇯🇵 Asien</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>📊 Meeresspiegel einstellen</h3>
                    <div class="slider-container">
                        <label class="slider-label" for="seaLevelSlider">Anstieg in Metern:</label>
                        <input type="range" id="seaLevelSlider" class="slider" min="0" max="5" step="0.1" value="0">
                        <div class="value-display" id="valueDisplay">0.0 Meter</div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="resetSimulator()">🔄 Zurücksetzen</button>
                        <button class="btn btn-secondary" onclick="showScenario()">📋 Szenario</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>🏙️ Städte-Status</h3>
                    <div class="cities-status" id="citiesStatus">
                        <div class="city-item">
                            <div class="status-indicator status-safe"></div>
                            <span>Lade Städtedaten...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="map-legend">
                    <div class="legend-title">Legende</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>Überflutete Städte</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f1c40f;"></div>
                        <span>Gefährdete Städte</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #27ae60;"></div>
                        <span>Sichere Städte</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db; opacity: 0.4;"></div>
                        <span>Überschwemmungsgebiete</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>🌡️ Was passiert beim Meeresspiegelanstieg?</h3>
                <p><strong>Hauptursachen:</strong></p>
                <ul>
                    <li><strong>Thermische Ausdehnung:</strong> Wärmeres Meerwasser dehnt sich aus und braucht mehr Platz</li>
                    <li><strong>Gletscherschmelze:</strong> Eis von Gletschern und Polkappen schmilzt und fließt ins Meer</li>
                    <li><strong>Eisschild-Kollaps:</strong> Große Eisschilde in Grönland und der Antarktis werden instabil</li>
                </ul>
                <p>Bereits eine geringe Erwärmung hat große Folgen für den Meeresspiegel!</p>
            </div>

            <div class="info-card">
                <h3>🏘️ Welche Folgen hat es?</h3>
                <p><strong>Betroffene Bereiche:</strong></p>
                <ul>
                    <li><strong>Küstenstädte:</strong> Millionen Menschen müssen umsiedeln</li>
                    <li><strong>Landwirtschaft:</strong> Salzwasser verseucht fruchtbare Böden</li>
                    <li><strong>Trinkwasser:</strong> Grundwasser wird durch Meerwasser verschmutzt</li>
                    <li><strong>Infrastruktur:</strong> Häfen, Flughäfen und Straßen werden überflutet</li>
                </ul>
                <p>Die Folgen treffen besonders ärmere Länder hart!</p>
            </div>

            <div class="info-card">
                <h3>💚 Was können wir dagegen tun?</h3>
                <p><strong>Klimaschutzmaßnahmen:</strong></p>
                <ul>
                    <li><strong>Erneuerbare Energien:</strong> Sonne, Wind und Wasser statt Kohle und Öl</li>
                    <li><strong>Weniger Auto fahren:</strong> Fahrrad, Bus und Bahn nutzen</li>
                    <li><strong>Energiesparen:</strong> Zuhause und in der Schule bewusst heizen</li>
                    <li><strong>Bewusst einkaufen:</strong> Regional und saisonal essen</li>
                </ul>
                <p><strong>Jeder kann etwas tun!</strong> Auch kleine Schritte helfen dem Klima.</p>
            </div>
        </div>

        <div class="quiz-section">
            <div class="quiz-header">
                <h2>🧠 Teste dein Wissen!</h2>
                <div class="quiz-score">
                    <span id="quizScore">0</span> / <span id="totalQuestions">5</span> Punkte
                </div>
            </div>
            <div class="quiz-progress">
                <div class="quiz-progress-bar" id="progressBar"></div>
            </div>
            <div class="question-container" id="questionContainer">
                <!-- Quiz-Fragen werden hier dynamisch eingefügt -->
            </div>
            <div class="quiz-navigation">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">⬅️ Zurück</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Weiter ➡️</button>
            </div>
        </div>

        <!-- Footer mit Copyright -->
        <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <p style="color: #7f8c8d; font-size: 0.9em; margin: 0;">
                © 2025 – Lehrprojekt „Meeresspiegelanstieg". Einwohnerzahlen: grobe Schätzwerte (Datenstand 2024/2025).
            </p>
        </div>
    </div>

    <!-- Tooltip für Karten-Interaktionen -->
    <div class="tooltip" id="tooltip" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let currentSeaLevel = 0;
        let currentRegion = 'world';
        let cityMarkers = [];
        let floodLayer; // Der Hauptflood-Layer
        let currentQuestion = 0;
        let quizScore = 0;
        let quizAnswered = [];

        // Globale Variable für Meeresspiegel (wird vom Slider gesetzt)
        let seaLevelMeters = 0;

        // Benutzerdefinierten GridLayer für Terrarium-Höhendaten erstellen
        const FloodGridLayer = L.GridLayer.extend({
            createTile: function (coords, done) {
                const tile = document.createElement('canvas');
                tile.width = tile.height = 256;
                const ctx = tile.getContext('2d');
                
                // Terrarium-Bild laden
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // Bild auf Canvas zeichnen
                        ctx.drawImage(img, 0, 0, 256, 256);
                        
                        // Pixel-Daten abrufen
                        const imageData = ctx.getImageData(0, 0, 256, 256);
                        const data = imageData.data;
                        
                        // Jeden Pixel durchgehen
                        for (let i = 0; i < data.length; i += 4) {
                            const R = data[i];
                            const G = data[i + 1];
                            const B = data[i + 2];
                            
                            // Terrarium-Decodierung: elevation = (R * 256 + G + B/256) - 32768
                            const elevation_meters = (R * 256 + G + B / 256) - 32768;
                            
                            // Überflutung prüfen
                            if (elevation_meters <= seaLevelMeters) {
                                // Überflutet: Blau setzen
                                data[i] = 45;      // R
                                data[i + 1] = 126; // G
                                data[i + 2] = 247; // B
                                data[i + 3] = 140; // Alpha (0.55 * 255 ≈ 140)
                            } else {
                                // Nicht überflutet: Transparent
                                data[i + 3] = 0;   // Alpha = 0
                            }
                        }
                        
                        // Optional: 3x3 Median-Filter zur Glättung
                        if (seaLevelMeters > 0) {
                            this.applyMedianFilter(data, 256, 256);
                        }
                        
                        // Modifizierte Daten zurück auf Canvas
                        ctx.putImageData(imageData, 0, 0);
                        
                    } catch (error) {
                        console.warn('Terrarium-Tile konnte nicht geladen werden:', error);
                        // Bei Fehlern leeres transparentes Tile
                        ctx.clearRect(0, 0, 256, 256);
                    }
                    
                    // Fertig - Callback aufrufen wenn vorhanden
                    if (done) done(null, tile);
                };
                
                img.onerror = () => {
                    console.warn('Terrarium-Tile Ladefehler für Koordinaten:', coords);
                    ctx.clearRect(0, 0, 256, 256);
                    if (done) done(null, tile);
                };
                
                // Terrarium-URL konstruieren
                const terrariumUrl = `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${coords.z}/${coords.x}/${coords.y}.png`;
                img.src = terrariumUrl;
                
                return tile;
            },
            
            // 3x3 Median-Filter zur Rauschreduktion
            applyMedianFilter: function(data, width, height) {
                const filtered = new Uint8ClampedArray(data);
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        
                        // Nur Alpha-Werte für Median betrachten
                        const alphaValues = [];
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const nIdx = ((y + dy) * width + (x + dx)) * 4;
                                alphaValues.push(data[nIdx + 3]);
                            }
                        }
                        
                        // Median berechnen
                        alphaValues.sort((a, b) => a - b);
                        const median = alphaValues[4]; // Mittlerer Wert von 9
                        
                        // Nur übernehmen wenn genug Nachbarn überflutet sind
                        if (median > 100) {
                            filtered[idx + 3] = median;
                        } else if (median < 50) {
                            filtered[idx + 3] = 0;
                        }
                    }
                }
                
                // Gefilterte Werte zurückkopieren
                for (let i = 0; i < data.length; i++) {
                    data[i] = filtered[i];
                }
            }
        });

        // Karte initialisieren
        function initMap() {
            map = L.map('map', {
                center: [30, 0],
                zoom: 2,
                minZoom: 2,
                maxBounds: [[-85, -180], [85, 180]],
                maxBoundsViscosity: 1.0,
                worldCopyJump: true,
                noWrap: false
            });
            
            // Basis-Kartenlayer (OSM Deutschland)
            L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors, © OpenStreetMap Deutschland',
                maxZoom: 18,
                noWrap: false
            }).addTo(map);

            // Überflutungs-Layer erstellen und hinzufügen
            floodLayer = new FloodGridLayer({
                opacity: 1.0,
                zIndex: 1000
            }).addTo(map);

            initializeCityMarkers();
            selectRegion('world');
        }

        // Städte-Datenbank mit realistischen Werten
        const cities = [
            {name: "Venedig", country: "Italien", lat: 45.4408, lng: 12.3155, population: 0.26, threshold: 0.5, info: "Historische Stadt, bereits heute von Überschwemmungen betroffen"},
            {name: "Miami", country: "USA", lat: 25.7617, lng: -80.1918, population: 6.2, threshold: 1.0, info: "Flacher Küstenbereich, besonders gefährdet"},
            {name: "Hamburg", country: "Deutschland", lat: 53.5511, lng: 9.9937, population: 1.9, threshold: 1.5, info: "Hafenstadt an der Elbe, moderne Deichsysteme"},
            {name: "Amsterdam", country: "Niederlande", lat: 52.3676, lng: 4.9041, population: 0.87, threshold: 0.8, info: "Liegt teilweise unter dem Meeresspiegel"},
            {name: "Kopenhagen", country: "Dänemark", lat: 55.6761, lng: 12.5683, population: 1.3, threshold: 1.2, info: "Flaches Küstengebiet, innovative Klimaanpassung"},
            {name: "New York", country: "USA", lat: 40.7128, lng: -74.0060, population: 8.4, threshold: 1.8, info: "Manhattan besonders gefährdet durch Sturmfluten"},
            {name: "London", country: "Großbritannien", lat: 51.5074, lng: -0.1278, population: 9.0, threshold: 2.0, info: "Thames Barrier schützt bis 2 Meter Anstieg"},
            {name: "Tokio", country: "Japan", lat: 35.6762, lng: 139.6503, population: 37.4, threshold: 1.5, info: "Tiefliegende Gebiete, Erdbebengefahr zusätzlich"},
            {name: "Bangkok", country: "Thailand", lat: 13.7563, lng: 100.5018, population: 10.5, threshold: 1.0, info: "Stadt sinkt zusätzlich ab, doppelte Gefahr"},
            {name: "Alexandria", country: "Ägypten", lat: 31.2001, lng: 29.9187, population: 5.2, threshold: 1.2, info: "Nildelta besonders gefährdet"},
            {name: "Shanghai", country: "China", lat: 31.2304, lng: 121.4737, population: 26.3, threshold: 1.3, info: "Riesige Bevölkerung in gefährdeter Zone"},
            {name: "Mumbai", country: "Indien", lat: 19.0760, lng: 72.8777, population: 20.4, threshold: 1.4, info: "Monsunregen verstärkt Überschwemmungsrisiko"},
            {name: "Lagos", country: "Nigeria", lat: 6.5244, lng: 3.3792, population: 15.4, threshold: 1.1, info: "Schnell wachsende Küstenstadt"},
            {name: "Rio de Janeiro", country: "Brasilien", lat: -22.9068, lng: -43.1729, population: 6.7, threshold: 1.6, info: "Berge bieten Schutz, aber Favelas gefährdet"},
            {name: "Sydney", country: "Australien", lat: -33.8688, lng: 151.2093, population: 5.3, threshold: 1.4, info: "Harbour Bridge Bereich besonders betroffen"},
            {name: "San Francisco", country: "USA", lat: 37.7749, lng: -122.4194, population: 0.87, threshold: 1.7, info: "Silicon Valley teilweise überflutet"},
            {name: "Barcelona", country: "Spanien", lat: 41.3851, lng: 2.1734, population: 1.6, threshold: 1.3, info: "Mittelmeerküste, Strände verschwinden"},
            {name: "Istanbul", country: "Türkei", lat: 41.0082, lng: 28.9784, population: 15.5, threshold: 1.4, info: "Bosporus-Region, historische Altstadt gefährdet"},
            {name: "Sinop", country: "Türkei", lat: 42.0231, lng: 35.1531, population: 0.1, threshold: 1.1, info: "Schwarzmeer-Küste, kleine Hafenstadt auf Halbinsel"},
            {name: "Izmir", country: "Türkei", lat: 38.4192, lng: 27.1287, population: 4.4, threshold: 1.2, info: "Ägäis-Küste, großer Hafen und Industriezentrum"},
            {name: "Antalya", country: "Türkei", lat: 36.8969, lng: 30.7133, population: 2.5, threshold: 1.3, info: "Mittelmeer-Küste, Touristenzentrum mit Hafen"},
            {name: "Hatay", country: "Türkei", lat: 36.4018, lng: 36.3498, population: 1.6, threshold: 1.0, info: "Mittelmeer-Nähe, flache Küstenebenen gefährdet"},
            {name: "Boston", country: "USA", lat: 42.3601, lng: -71.0589, population: 0.69, threshold: 1.5, info: "Back Bay Gebiet unter Wasser"},
            {name: "Dhaka", country: "Bangladesch", lat: 23.8103, lng: 90.4125, population: 22.0, threshold: 0.8, info: "Einer der gefährdetsten Orte weltweit"},
            {name: "Ho-Chi-Minh-Stadt", country: "Vietnam", lat: 10.8231, lng: 106.6297, population: 9.0, threshold: 0.9, info: "Mekong-Delta extrem flach"},
            {name: "Jakarta", country: "Indonesien", lat: -6.2088, lng: 106.8456, population: 10.6, threshold: 0.7, info: "Stadt sinkt jährlich mehrere Zentimeter"},
            {name: "Manila", country: "Philippinen", lat: 14.5995, lng: 120.9842, population: 13.9, threshold: 1.1, info: "Taifune verstärken Überschwemmungen"},
            {name: "Karachi", country: "Pakistan", lat: 24.8607, lng: 67.0011, population: 16.0, threshold: 1.3, info: "Arabisches Meer, Monsun-Problematik"}
        ];

        // Quiz-Fragen
        const quizQuestions = [
            {
                question: "Welche Hauptursache hat der Meeresspiegelanstieg NICHT?",
                options: ["Thermische Ausdehnung des Meerwassers", "Schmelzende Gletscher", "Mehr Regen über den Ozeanen", "Kollaps von Eisschilden"],
                correct: 2,
                explanation: "Mehr Regen führt nicht zu einem höheren Meeresspiegel, da das Wasser im Wasserkreislauf bleibt. Die Hauptursachen sind wärmeres, sich ausdehnendes Wasser und schmelzende Eismassen."
            },
            {
                question: "Bei welchem Meeresspiegelanstieg wären die Niederlande am stärksten betroffen?",
                options: ["0,5 Meter", "1 Meter", "2 Meter", "5 Meter"],
                correct: 3,
                explanation: "Bei 5 Metern Anstieg wären etwa 80% der Niederlande überflutet, da große Teile des Landes bereits unter dem aktuellen Meeresspiegel liegen."
            },
            {
                question: "Welche Stadt ist bereits heute regelmäßig von Überschwemmungen betroffen?",
                options: ["Hamburg", "Venedig", "Berlin", "München"],
                correct: 1,
                explanation: "Venedig erlebt bereits heute regelmäßig 'Acqua Alta' - Hochwasser, das Teile der Stadt überschwemmt. Die Stadt liegt nur wenige Zentimeter über dem Meeresspiegel."
            },
            {
                question: "Was können Schüler NICHT direkt gegen den Klimawandel tun?",
                options: ["Weniger Auto fahren", "Energiesparen zuhause", "Neue Deiche bauen", "Regional einkaufen"],
                correct: 2,
                explanation: "Der Bau von Deichen ist eine staatliche Aufgabe. Schüler können aber durch bewusstes Verhalten im Alltag zum Klimaschutz beitragen."
            },
            {
                question: "Um wie viel steigt der Meeresspiegel derzeit pro Jahr?",
                options: ["1 mm", "3,3 mm", "10 mm", "50 mm"],
                correct: 1,
                explanation: "Der aktuelle Meeresspiegelanstieg beträgt etwa 3,3 mm pro Jahr. Das erscheint wenig, aber über Jahrzehnte summiert sich das zu mehreren Dezimetern."
            }
        ];

        // Karte initialisieren
        function initMap() {
            map = L.map('map', {
                maxBounds: [[-85, -180], [85, 180]],
                maxBoundsViscosity: 1.0
            }).setView([30, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors, © OpenStreetMap Deutschland',
                maxZoom: 18
            }).addTo(map);

            initializeCityMarkers();
            selectRegion('world');
        }

        // Städte-Marker initialisieren
        function initializeCityMarkers() {
            cities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: Math.min(8 + Math.log(city.population) * 2, 15),
                    fillColor: getStatusColor(city, currentSeaLevel),
                    color: '#2c3e50',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.on('mouseover', function(e) {
                    showTooltip(e, city);
                });

                marker.on('mouseout', function() {
                    hideTooltip();
                });

                marker.on('click', function() {
                    const status = getStatusText(city, currentSeaLevel);
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${city.name}, ${city.country}</h4>
                            <p style="margin: 5px 0;"><strong>Einwohner:</strong> ${city.population} Mio.</p>
                            <p style="margin: 5px 0;"><strong>Gefährdung ab:</strong> ${city.threshold}m Anstieg</p>
                            <p style="margin: 5px 0;"><strong>Status:</strong> ${status}</p>
                            <p style="margin: 5px 0; font-size: 0.9em; color: #555;">${city.info}</p>
                        </div>
                    `;
                    marker.bindPopup(popupContent).openPopup();
                });

                cityMarkers.push({marker, city});
            });
        }

        // Tooltip anzeigen
        function showTooltip(e, city) {
            const tooltip = document.getElementById('tooltip');
            const status = getStatusText(city, currentSeaLevel);
            const threatLevel = currentSeaLevel >= city.threshold ? '🚨' : 
                               currentSeaLevel >= city.threshold - 0.5 ? '⚠️' : '✅';
            
            tooltip.innerHTML = `
                <strong>${threatLevel} ${city.name}</strong><br>
                ${city.population} Mio. Einwohner<br>
                Status: ${status}
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = e.originalEvent.pageX + 10 + 'px';
            tooltip.style.top = e.originalEvent.pageY - 10 + 'px';
        }

        // Tooltip verstecken
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        // Status-Farbe basierend auf Meeresspiegel
        function getStatusColor(city, seaLevel) {
            if (seaLevel >= city.threshold) return '#3498db'; // Blau - überflutet
            if (seaLevel >= city.threshold - 0.5) return '#f1c40f'; // Gelb - gefährdet
            return '#27ae60'; // Grün - sicher
        }

        // Status-Text für Stadt
        function getStatusText(city, seaLevel) {
            if (seaLevel >= city.threshold) return 'Überflutet';
            if (seaLevel >= city.threshold - 0.5) return 'Stark gefährdet';
            return 'Sicher';
        }

        // Region auswählen
        function selectRegion(region) {
            // Aktive Region markieren - finde den richtigen Button
            document.querySelectorAll('.region-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('Weltkarte') && region === 'world' ||
                    btn.textContent.includes('Europa') && region === 'europe' ||
                    btn.textContent.includes('Nordamerika') && region === 'america' ||
                    btn.textContent.includes('Asien') && region === 'asia') {
                    btn.classList.add('active');
                }
            });
            
            currentRegion = region;
            
            const regions = {
                world: {center: [30, 0], zoom: 2},
                europe: {center: [54, 15], zoom: 4}, // Erweitert für Türkei
                america: {center: [45, -100], zoom: 3},
                asia: {center: [35, 100], zoom: 3}
            };
            
            const regionData = regions[region];
            map.setView(regionData.center, regionData.zoom);
            
            // Karten-Grenzen für Region setzen
            if (region !== 'world') {
                const bounds = {
                    europe: [[35, -10], [72, 45]], // Erweitert um Türkei einzuschließen
                    america: [[15, -170], [75, -30]],
                    asia: [[5, 60], [75, 150]]
                };
                map.setMaxBounds(bounds[region]);
            } else {
                map.setMaxBounds([[-85, -180], [85, 180]]);
            }
            
            // Debug: Türkische Städte hervorheben
            if (region === 'europe') {
                console.log('Europa-Region ausgewählt - Türkische Städte:');
                const turkishCities = cities.filter(city => city.country === 'Türkei');
                turkishCities.forEach(city => {
                    console.log(`${city.name}: Lat ${city.lat}, Lng ${city.lng}`);
                });
            }
        }

        // Meeresspiegel-Slider Event - Echtzeit-Aktualisierung
        document.getElementById('seaLevelSlider').addEventListener('input', function(e) {
            currentSeaLevel = parseFloat(e.target.value);
            seaLevelMeters = currentSeaLevel; // Globale Variable setzen
            document.getElementById('valueDisplay').textContent = currentSeaLevel.toFixed(1) + ' Meter';
            
            // Sofortiges Redraw des Flood-Layers
            if (floodLayer) {
                floodLayer.redraw();
            }
            
            updateSimulation();
        });

        // Simulation aktualisieren (ohne Flood-Layer, der wird separat per redraw() aktualisiert)
        function updateSimulation() {
            updateCityMarkers();
            updateCitiesStatus();
        }

        // Stadt-Marker aktualisieren
        function updateCityMarkers() {
            cityMarkers.forEach(({marker, city}) => {
                marker.setStyle({
                    fillColor: getStatusColor(city, currentSeaLevel)
                });
            });
        }



        // Städte-Status aktualisieren
        function updateCitiesStatus() {
            const statusContainer = document.getElementById('citiesStatus');
            const sortedCities = cities.sort((a, b) => {
                const statusA = currentSeaLevel >= a.threshold ? 2 : (currentSeaLevel >= a.threshold - 0.5 ? 1 : 0);
                const statusB = currentSeaLevel >= b.threshold ? 2 : (currentSeaLevel >= b.threshold - 0.5 ? 1 : 0);
                return statusB - statusA || a.name.localeCompare(b.name);
            });
            
            statusContainer.innerHTML = sortedCities.map(city => {
                const status = getStatusText(city, currentSeaLevel);
                const statusClass = currentSeaLevel >= city.threshold ? 'status-flooded' : 
                                   currentSeaLevel >= city.threshold - 0.5 ? 'status-risk' : 'status-safe';
                
                return `
                    <div class="city-item">
                        <div class="status-indicator ${statusClass}"></div>
                        <span><strong>${city.name}</strong> (${city.population}M) - ${status}</span>
                    </div>
                `;
            }).join('');
        }

        // Simulator zurücksetzen
        function resetSimulator() {
            document.getElementById('seaLevelSlider').value = 0;
            currentSeaLevel = 0;
            seaLevelMeters = 0; // Globale Variable zurücksetzen
            document.getElementById('valueDisplay').textContent = '0.0 Meter';
            updateSimulation();
            selectRegion('world');
        }

        // Szenario anzeigen
        function showScenario() {
            let scenarioText = '';
            
            if (currentSeaLevel === 0) {
                scenarioText = 'Aktueller Zustand: Noch kein signifikanter Anstieg, aber bereits heute leiden Küstengemeinden unter häufigeren Sturmfluten.';
            } else if (currentSeaLevel <= 0.5) {
                scenarioText = 'Frühes Stadium: Kleine Inselstaaten wie Tuvalu sind akut bedroht. Venedig erlebt häufigere Überschwemmungen.';
            } else if (currentSeaLevel <= 1) {
                scenarioText = 'Kritische Phase: Etwa 630 Millionen Menschen sind betroffen. Malediven und andere Inselstaaten sind größtenteils überflutet.';
            } else if (currentSeaLevel <= 2) {
                scenarioText = 'Dramatisches Szenario: Massive Bevölkerungsumsiedlungen nötig. Bangladesch verliert 30% seiner Landfläche.';
            } else if (currentSeaLevel <= 5) {
                scenarioText = 'Extremszenario: Entspricht dem Kollaps des westantarktischen Eisschildes. Niederlande zu 80% überflutet.';
            } else {
                scenarioText = 'Katastrophenszenario: Komplette Neuzeichnung der Weltkarte nötig. Hunderte Millionenstädte unbewohnbar.';
            }
            
            alert(`Szenario bei ${currentSeaLevel.toFixed(1)}m Meeresspiegelanstieg:\n\n${scenarioText}`);
        }

        // Quiz initialisieren
        function initQuiz() {
            quizAnswered = new Array(quizQuestions.length).fill(false);
            displayQuestion();
            updateQuizProgress();
        }

        // Frage anzeigen
        function displayQuestion() {
            const question = quizQuestions[currentQuestion];
            const container = document.getElementById('questionContainer');
            
            container.innerHTML = `
                <div class="question-text">
                    Frage ${currentQuestion + 1}: ${question.question}
                </div>
                <div class="quiz-options">
                    ${question.options.map((option, index) => 
                        `<div class="quiz-option" onclick="selectAnswer(${index})" data-index="${index}">
                            ${String.fromCharCode(65 + index)}) ${option}
                        </div>`
                    ).join('')}
                </div>
                <div class="quiz-feedback" id="feedback" style="display: none;"></div>
            `;
            
            updateNavigationButtons();
            updateQuizProgress();
        }

        // Antwort auswählen
        function selectAnswer(selectedIndex) {
            if (quizAnswered[currentQuestion]) return;
            
            const question = quizQuestions[currentQuestion];
            const options = document.querySelectorAll('.quiz-option');
            const feedback = document.getElementById('feedback');
            
            quizAnswered[currentQuestion] = true;
            
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none';
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex) {
                    option.classList.add('incorrect');
                }
            });
            
            const isCorrect = selectedIndex === question.correct;
            if (isCorrect) quizScore++;
            
            feedback.style.display = 'block';
            feedback.className = `quiz-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedback.style.background = isCorrect ? '#d4edda' : '#f8d7da';
            feedback.style.color = isCorrect ? '#155724' : '#721c24';
            feedback.innerHTML = `
                ${isCorrect ? '✅ <strong>Richtig!</strong>' : '❌ <strong>Leider falsch.</strong>'}<br>
                ${question.explanation}
            `;
            
            document.getElementById('quizScore').textContent = quizScore;
            updateQuizProgress();
        }

        // Nächste Frage
        function nextQuestion() {
            if (currentQuestion < quizQuestions.length - 1) {
                currentQuestion++;
                displayQuestion();
            } else {
                showQuizResults();
            }
        }

        // Vorherige Frage
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }

        // Navigation-Buttons aktualisieren
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.style.display = currentQuestion > 0 ? 'block' : 'none';
            nextBtn.textContent = currentQuestion < quizQuestions.length - 1 ? 'Weiter ➡️' : 'Ergebnis 🏆';
        }

        // Quiz-Fortschritt aktualisieren
        function updateQuizProgress() {
            if (quizQuestions.length <= 1) {
                document.getElementById('progressBar').style.width = '100%';
                return;
            }
            const progress = (currentQuestion / (quizQuestions.length)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
        }

        // Quiz-Ergebnisse anzeigen
        function showQuizResults() {
            const container = document.getElementById('questionContainer');
            const percentage = Math.round((quizScore / quizQuestions.length) * 100);
            
            let grade = '';
            let message = '';
            
            if (percentage >= 80) {
                grade = '🏆 Ausgezeichnet!';
                message = 'Du bist ein echter Klimaexperte! Dein Wissen über den Meeresspiegelanstieg ist beeindruckend.';
            } else if (percentage >= 60) {
                grade = '🥈 Gut gemacht!';
                message = 'Du hast schon viel über den Klimawandel gelernt. Mit etwas mehr Übung wirst du zum Experten!';
            } else if (percentage >= 40) {
                grade = '🥉 Nicht schlecht!';
                message = 'Du kennst die Grundlagen. Lies dir die Erklärungen nochmal durch und vertiefe dein Wissen!';
            } else {
                grade = '📚 Mehr lernen!';
                message = 'Das Thema ist komplex - lass dich nicht entmutigen! Experimentiere mehr mit dem Simulator.';
            }
            
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">${grade}</h3>
                    <div style="font-size: 2em; margin: 20px 0; color: #3498db;">
                        ${quizScore} / ${quizQuestions.length}
                    </div>
                    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px; color: #2c3e50;">
                        ${percentage}% richtig
                    </div>
                    <p style="font-size: 1.1em; line-height: 1.5; color: #555;">
                        ${message}
                    </p>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="restartQuiz()">
                        🔄 Quiz wiederholen
                    </button>
                </div>
            `;
            
            document.getElementById('prevBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('progressBar').style.width = '100%';
        }

        // Quiz neu starten
        function restartQuiz() {
            currentQuestion = 0;
            quizScore = 0;
            quizAnswered = new Array(quizQuestions.length).fill(false);
            document.getElementById('quizScore').textContent = '0';
            document.getElementById('nextBtn').style.display = 'block';
            displayQuestion();
            updateQuizProgress();
        }

        // Bei Laden der Seite initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initQuiz();
            updateCitiesStatus();
            
            // Event-Listener für Region-Buttons korrekt setzen
            document.querySelector('.region-btn:nth-child(1)').addEventListener('click', () => selectRegion('world'));
            document.querySelector('.region-btn:nth-child(2)').addEventListener('click', () => selectRegion('europe'));
            document.querySelector('.region-btn:nth-child(3)').addEventListener('click', () => selectRegion('america'));
            document.querySelector('.region-btn:nth-child(4)').addEventListener('click', () => selectRegion('asia'));
        });
    </script>
</body>
</html>